# Nazwa Twojego workflow - pojawi się w zakładce "Actions" na GitHubie
name: Build and Deploy Expo Web App

# Kiedy workflow ma się uruchamiać?
# W tym przypadku: przy każdym pushu do gałęzi "main"
on:
  push:
    branches: ["main"] # Możesz zmienić na "master" jeśli tak nazywa się Twoja główna gałąź

# Definicja zadań do wykonania
jobs:
  build-and-deploy:
    # Na jakim systemie ma się uruchomić? Najnowsza wersja Ubuntu
    runs-on: ubuntu-latest
    permissions:
      contents: write # Nadaje uprawnienia do zapisu w repozytorium (potrzebne do wdrożenia)
    steps:
      # 1. Pobranie kodu źródłowego z repozytorium
      - name: Check out your repository
        uses: actions/checkout@v4

      # 2. Ustawienie środowiska Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18" # Użyj wersji Node.js, której używasz lokalnie
          cache: "npm" # Włącza cache'owanie pakietów npm dla szybszych buildów

      # 3. Instalacja zależności projektu
      - name: Install dependencies
        run: |
          npm cache clean --force
          npm ci

      # 4. Budowanie aplikacji webowej Expo
      - name: Build Expo web app
        env:
          EXPO_PUBLIC_ROUTER_BASEPATH: /kalk-tablet-app/
        run: npx expo export --clear

      # 5. NOWY KROK: Wymuszenie poprawnych ścieżek
      - name: Fix asset paths
        run: |
          find ./dist -type f -name "*.html" -exec sed -i 's|href="/|href="/kalk-tablet-app/|g' {} +
          find ./dist -type f -name "*.html" -exec sed -i 's|src="/|src="/kalk-tablet-app/|g' {} +
          find ./dist -type f -name "*.js" -exec sed -i 's|"/_expo/|"/kalk-tablet-app/_expo/|g' {} +

      # 6. Wdrożenie na GitHub Pages (dawny krok 5)asdasdsa
      # lol
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
